<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Automatizaria</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/styles.css">

<body>
    <!-- Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1>ü§ñ Painel Automatizaria</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usu√°rio</label>
                    <input type="text" id="username" name="username" required placeholder="Digite seu usu√°rio">
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" name="password" required placeholder="Digite sua senha">
                </div>
                <button type="submit" class="btn">Entrar</button>
                <div id="loginError" class="error" style="display:none;"></div>
                <div style="margin-top:2rem;font-size:0.8rem;color:#b0b0b0;text-align:center;">
                    <p><strong>Demo:</strong></p>
                    <p>Admin: admin / admin123</p>
                    <p>Cliente: cliente1 / cliente123</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardScreen" class="dashboard container">
        <div class="header">
            <div>
                <h1>Dashboard</h1>
                <p id="welcomeMessage">Bem-vindo!</p>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div>
                    <div id="userName">Usu√°rio</div>
                    <div style="font-size:0.8rem;color:#b0b0b0;" id="userRole">Role</div>
                </div>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </div>
        <div id="dashboardContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>Carregando dashboard...</p>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let authToken = null;

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showDashboard();
                } else {
                    errorDiv.textContent = data.error || 'Erro no login';
                    errorDiv.style.display = 'block';
                }
            } catch (err) {
                errorDiv.textContent = 'Erro de conex√£o';
                errorDiv.style.display = 'block';
            }
        });

        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                showDashboard();
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').classList.add('active');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role==='admin'?'Administrador':'Cliente';
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('welcomeMessage').textContent = `Bem-vindo, ${currentUser.name}!`;
            loadDashboardData();
        }

        async function loadDashboardData() {
            const endpoint = currentUser.role==='admin'?'/api/admin/dashboard':'/api/client/dashboard';
            try {
                const response = await fetch(endpoint, { headers:{ 'Authorization':`Bearer ${authToken}` }});
                if(response.ok){
                    const data = await response.json();
                    renderDashboard(data);
                }else throw new Error('Erro ao carregar dados');
            } catch(err){
                document.getElementById('dashboardContent').innerHTML = `<div class="error">Erro ao carregar dashboard: ${err.message}</div>`;
            }
        }

        function renderDashboard(data){
            const container = document.getElementById('dashboardContent');
            if(currentUser.role==='admin') renderAdminDashboard(data, container);
            else renderClientDashboard(data, container);
        }

        function renderAdminDashboard(data, container){
            container.innerHTML=`
                <div class="stats-grid">
                    <div class="stat-card"><div class="icon">ü§ñ</div><div class="value">${data.overview.totalAgents}</div><div class="label">Agentes Ativos</div></div>
                    <div class="stat-card"><div class="icon">üë•</div><div class="value">${data.overview.totalClients}</div><div class="label">Clientes</div></div>
                    <div class="stat-card"><div class="icon">üí¨</div><div class="value">${data.overview.totalMessages}</div><div class="label">Mensagens</div></div>
                    <div class="stat-card"><div class="icon">üí∞</div><div class="value">R$ ${data.overview.totalEconomy.toFixed(2)}</div><div class="label">Economia</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h3>Mensagens por Agente</h3><canvas id="messagesChart"></canvas></div>
                    <div class="chart-card"><h3>Status do Sistema</h3><canvas id="systemChart"></canvas></div>
                </div>
            `;
            const agentNames = data.recentAgents.map(a=>a.name);
            const agentMessages = data.recentAgents.map(a=>a.messagesCount);
            new Chart(document.getElementById('messagesChart').getContext('2d'),{
                type:'bar',data:{labels:agentNames,datasets:[{label:'Mensagens',data:agentMessages,backgroundColor:'#667eea'}]},options:{responsive:true,plugins:{legend:{display:false}}}
            });
            new Chart(document.getElementById('systemChart').getContext('2d'),{
                type:'doughnut',data:{labels:['CPU (%)','Mem√≥ria (%)','Disco (%)'],datasets:[{data:[data.systemHealth.cpu.toFixed(0),data.systemHealth.memory.toFixed(0),data.systemHealth.disk.toFixed(0)],backgroundColor:['#667eea','#764ba2','#4ade80']}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}
            });
        }

        function renderClientDashboard(data, container){
            container.innerHTML=`
                <div class="stats-grid">
                    <div class="stat-card"><div class="icon">ü§ñ</div><div class="value">${data.overview.totalAgents}</div><div class="label">Agentes</div></div>
                    <div class="stat-card"><div class="icon">üí¨</div><div class="value">${data.overview.totalMessages}</div><div class="label">Mensagens</div></div>
                    <div class="stat-card"><div class="icon">üó£Ô∏è</div><div class="value">${data.overview.totalConversations}</div><div class="label">Conversas</div></div>
                    <div class="stat-card"><div class="icon">‚è±Ô∏è</div><div class="value">${data.overview.totalHoursWorked.toFixed(1)}</div><div class="label">Horas Trabalhadas</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h3>Mensagens √∫ltimos 30 dias</h3><canvas id="messagesMonthChart"></canvas></div>
                    <div class="chart-card"><h3>Conversas √∫ltimos 30 dias</h3><canvas id="conversationsMonthChart"></canvas></div>
                </div>
            `;
            const days=Array.from({length:30},(_,i)=>`Dia ${i+1}`);
            const messagesMonth=Array.from({length:30},()=>Math.floor(Math.random()*50)+10);
            const conversationsMonth=Array.from({length:30},()=>Math.floor(Math.random()*10)+1);
            new Chart(document.getElementById('messagesMonthChart').getContext('2d'),{type:'line',data:{labels:days,datasets:[{label:'Mensagens',data:messagesMonth,borderColor:'#667eea',backgroundColor:'rgba(102,126,234,0.2)',fill:true}]} ,options:{responsive:true}});
            new Chart(document.getElementById('conversationsMonthChart').getContext('2d'),{type:'line',data:{labels:days,datasets:[{label:'Conversas',data:conversationsMonth,borderColor:'#764ba2',backgroundColor:'rgba(118,75,162,0.2)',fill:true}]} ,options:{responsive:true}});
        }

        function logout(){
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            location.reload();
        }

        // Inicializa
        checkAuth();
    </script>
</body>
</html>
