<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Automatizaria</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* --- CSS j√° existente do seu painel --- */
        * {margin:0;padding:0;box-sizing:border-box;}
        body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%); color:white; min-height:100vh;}
        .container {max-width:1200px;margin:0 auto;padding:2rem;}
        /* Login */
        .login-container {display:flex;align-items:center;justify-content:center;min-height:100vh;padding:2rem;}
        .login-card {background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:20px;padding:3rem;width:100%;max-width:400px;border:1px solid rgba(255,255,255,0.2);box-shadow:0 20px 40px rgba(0,0,0,0.3);}
        .login-card h1 {text-align:center;margin-bottom:2rem;font-size:2rem;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .form-group {margin-bottom:1.5rem;}
        .form-group label {display:block;margin-bottom:0.5rem;color:#e0e0e0;}
        .form-group input {width:100%;padding:12px;border:1px solid rgba(255,255,255,0.2);border-radius:8px;background:rgba(255,255,255,0.1);color:white;font-size:16px;}
        .form-group input:focus {outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);}
        .btn {width:100%;padding:12px;background:linear-gradient(45deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;transition:all 0.3s ease;}
        .btn:hover {transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,0.3);}
        .dashboard {display:none;}
        .dashboard.active {display:block;}
        .header {display:flex;justify-content:space-between;align-items:center;margin-bottom:3rem;padding-bottom:1rem;border-bottom:1px solid rgba(255,255,255,0.1);}
        .header h1 {font-size:2.5rem;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .user-info {display:flex;align-items:center;gap:1rem;}
        .user-avatar {width:40px;height:40px;background:linear-gradient(45deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;}
        .logout-btn {padding:8px 16px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;cursor:pointer;transition:all 0.3s ease;}
        .logout-btn:hover {background:rgba(255,255,255,0.2);}
        .stats-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:2rem;margin-bottom:3rem;}
        .stat-card {background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:16px;padding:2rem;border:1px solid rgba(255,255,255,0.2);transition:all 0.3s ease;}
        .stat-card:hover {transform:translateY(-5px);box-shadow:0 20px 40px rgba(0,0,0,0.2);}
        .stat-card .icon {font-size:2.5rem;margin-bottom:1rem;}
        .stat-card .value {font-size:2.5rem;font-weight:bold;margin-bottom:0.5rem;}
        .stat-card .label {color:#b0b0b0;font-size:0.9rem;}
        .charts-grid {display:grid;grid-template-columns:2fr 1fr;gap:2rem;margin-bottom:3rem;}
        .chart-card {background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:16px;padding:2rem;border:1px solid rgba(255,255,255,0.2);}
        .chart-card h3 {margin-bottom:2rem;color:#e0e0e0;}
        .table-card {background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:16px;padding:2rem;border:1px solid rgba(255,255,255,0.2);}
        .table {width:100%;border-collapse:collapse;}
        .table th,.table td {text-align:left;padding:1rem;border-bottom:1px solid rgba(255,255,255,0.1);}
        .table th {color:#b0b0b0;font-weight:600;}
        .status {padding:4px 12px;border-radius:20px;font-size:0.8rem;font-weight:bold;}
        .status.active {background:rgba(74,222,128,0.2);color:#4ade80;}
        .status.inactive {background:rgba(248,113,113,0.2);color:#f87171;}
        @media (max-width:768px){.charts-grid{grid-template-columns:1fr;}.header{flex-direction:column;gap:1rem;text-align:center;}.stats-grid{grid-template-columns:1fr;}}
        .loading{text-align:center;padding:2rem;}
        .spinner{border:3px solid rgba(255,255,255,0.1);border-top:3px solid #667eea;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 1rem;}
        @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        .error{color:#f87171;text-align:center;padding:1rem;background:rgba(248,113,113,0.1);border-radius:8px;margin:1rem 0;}
    </style>
</head>
<body>
    <!-- Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1>ü§ñ Painel Automatizaria</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usu√°rio</label>
                    <input type="text" id="username" name="username" required placeholder="Digite seu usu√°rio">
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" name="password" required placeholder="Digite sua senha">
                </div>
                <button type="submit" class="btn">Entrar</button>
                <div id="loginError" class="error" style="display:none;"></div>
                <div style="margin-top:2rem;font-size:0.8rem;color:#b0b0b0;text-align:center;">
                    <p><strong>Demo:</strong></p>
                    <p>Admin: admin / admin123</p>
                    <p>Cliente: cliente1 / cliente123</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardScreen" class="dashboard container">
        <div class="header">
            <div>
                <h1>Dashboard</h1>
                <p id="welcomeMessage">Bem-vindo!</p>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div>
                    <div id="userName">Usu√°rio</div>
                    <div style="font-size:0.8rem;color:#b0b0b0;" id="userRole">Role</div>
                </div>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </div>
        <div id="dashboardContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>Carregando dashboard...</p>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let authToken = null;

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showDashboard();
                } else {
                    errorDiv.textContent = data.error || 'Erro no login';
                    errorDiv.style.display = 'block';
                }
            } catch (err) {
                errorDiv.textContent = 'Erro de conex√£o';
                errorDiv.style.display = 'block';
            }
        });

        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                showDashboard();
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').classList.add('active');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role==='admin'?'Administrador':'Cliente';
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('welcomeMessage').textContent = `Bem-vindo, ${currentUser.name}!`;
            loadDashboardData();
        }

        async function loadDashboardData() {
            const endpoint = currentUser.role==='admin'?'/api/admin/dashboard':'/api/client/dashboard';
            try {
                const response = await fetch(endpoint, { headers:{ 'Authorization':`Bearer ${authToken}` }});
                if(response.ok){
                    const data = await response.json();
                    renderDashboard(data);
                }else throw new Error('Erro ao carregar dados');
            } catch(err){
                document.getElementById('dashboardContent').innerHTML = `<div class="error">Erro ao carregar dashboard: ${err.message}</div>`;
            }
        }

        function renderDashboard(data){
            const container = document.getElementById('dashboardContent');
            if(currentUser.role==='admin') renderAdminDashboard(data, container);
            else renderClientDashboard(data, container);
        }

        function renderAdminDashboard(data, container){
            container.innerHTML=`
                <div class="stats-grid">
                    <div class="stat-card"><div class="icon">ü§ñ</div><div class="value">${data.overview.totalAgents}</div><div class="label">Agentes Ativos</div></div>
                    <div class="stat-card"><div class="icon">üë•</div><div class="value">${data.overview.totalClients}</div><div class="label">Clientes</div></div>
                    <div class="stat-card"><div class="icon">üí¨</div><div class="value">${data.overview.totalMessages}</div><div class="label">Mensagens</div></div>
                    <div class="stat-card"><div class="icon">üí∞</div><div class="value">R$ ${data.overview.totalEconomy.toFixed(2)}</div><div class="label">Economia</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h3>Mensagens por Agente</h3><canvas id="messagesChart"></canvas></div>
                    <div class="chart-card"><h3>Status do Sistema</h3><canvas id="systemChart"></canvas></div>
                </div>
            `;
            const agentNames = data.recentAgents.map(a=>a.name);
            const agentMessages = data.recentAgents.map(a=>a.messagesCount);
            new Chart(document.getElementById('messagesChart').getContext('2d'),{
                type:'bar',data:{labels:agentNames,datasets:[{label:'Mensagens',data:agentMessages,backgroundColor:'#667eea'}]},options:{responsive:true,plugins:{legend:{display:false}}}
            });
            new Chart(document.getElementById('systemChart').getContext('2d'),{
                type:'doughnut',data:{labels:['CPU (%)','Mem√≥ria (%)','Disco (%)'],datasets:[{data:[data.systemHealth.cpu.toFixed(0),data.systemHealth.memory.toFixed(0),data.systemHealth.disk.toFixed(0)],backgroundColor:['#667eea','#764ba2','#4ade80']}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}
            });
        }

        function renderClientDashboard(data, container){
            container.innerHTML=`
                <div class="stats-grid">
                    <div class="stat-card"><div class="icon">ü§ñ</div><div class="value">${data.overview.totalAgents}</div><div class="label">Agentes</div></div>
                    <div class="stat-card"><div class="icon">üí¨</div><div class="value">${data.overview.totalMessages}</div><div class="label">Mensagens</div></div>
                    <div class="stat-card"><div class="icon">üó£Ô∏è</div><div class="value">${data.overview.totalConversations}</div><div class="label">Conversas</div></div>
                    <div class="stat-card"><div class="icon">‚è±Ô∏è</div><div class="value">${data.overview.totalHoursWorked.toFixed(1)}</div><div class="label">Horas Trabalhadas</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h3>Mensagens √∫ltimos 30 dias</h3><canvas id="messagesMonthChart"></canvas></div>
                    <div class="chart-card"><h3>Conversas √∫ltimos 30 dias</h3><canvas id="conversationsMonthChart"></canvas></div>
                </div>
            `;
            const days=Array.from({length:30},(_,i)=>`Dia ${i+1}`);
            const messagesMonth=Array.from({length:30},()=>Math.floor(Math.random()*50)+10);
            const conversationsMonth=Array.from({length:30},()=>Math.floor(Math.random()*10)+1);
            new Chart(document.getElementById('messagesMonthChart').getContext('2d'),{type:'line',data:{labels:days,datasets:[{label:'Mensagens',data:messagesMonth,borderColor:'#667eea',backgroundColor:'rgba(102,126,234,0.2)',fill:true}]} ,options:{responsive:true}});
            new Chart(document.getElementById('conversationsMonthChart').getContext('2d'),{type:'line',data:{labels:days,datasets:[{label:'Conversas',data:conversationsMonth,borderColor:'#764ba2',backgroundColor:'rgba(118,75,162,0.2)',fill:true}]} ,options:{responsive:true}});
        }

        function logout(){
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            location.reload();
        }

        // Inicializa
        checkAuth();
    </script>
</body>
</html>
